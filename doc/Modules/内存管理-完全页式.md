# 内存管理模块设计与实现

* Author: iPear

## 涉及的代码文件

```
lib/brk_conrtol.h(.cpp)
lib/elf_conrtol.h(.cpp)
lib/mmap_conrtol.h(.cpp)
lib/memory_keeper.h(.cpp)
```

## 模块设计

从第二阶段开始，内存分配采用完全页式分配（不支持申请超过1页的连续内存）。用户程序的连续空间有多个页面拼接而成，在物理内存中不再有任何连续性。

## 分配方案

完全页式分配方案可以大幅度降低页分配器的实现难度和时间复杂度。

这里仅仅采用一个栈来维护已有的空闲页面。假设内存为8M/页大小4K=2K个标记，这是完全可以接受的。此时分配和回收页面的复杂度为纯粹的O(1)，速度比线段树有了大幅提升。

## 页面管理器

页面管理器包括以下部分：

BRK管理器：从虚拟地址0xc0000000开始分配内存，当brk请求更多页面时，申请新页面进行拼接。

ELF管理器：将ELF所有页面分为可写与不可写两部分（对应ELF中两个LOAD段）。FORK时，对于不可写页面，直接将引用计数+1；对于可写页面，进行复制。

MMAP管理器：以虚拟地址0x100000000起始，一直向后分配（不考虑前面释放），因为mmap命令并不能完全指定映射地址，地址实际由操作系统决定。

以上模块都大量使用了智能指针（引用计数指针），由于调度器中只存在线程管理块，在多个线程共用一个进程时，使用引用计数来控制进程释放操作。

![image-20210817015554129](https://gitlab.eduxiji.net/iPear/syscore/-/raw/main/doc/Modules/assets/alloc_page.png)

